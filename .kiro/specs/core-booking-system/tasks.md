# План реализации системы онлайн-записи Qlink

## Обзор

Этот документ содержит пошаговый план реализации базовой системы онлайн-записи Qlink. Каждая задача построена инкрементально и включает конкретные требования из документа требований.

## Задачи

- [x] 1. Настройка проекта и базовой инфраструктуры




  - Инициализировать монорепозиторий с workspace для backend и frontend
  - Настроить TypeScript конфигурацию для всех пакетов
  - Настроить ESLint и Prettier для единого стиля кода
  - Создать Docker Compose файл для локальной разработки (PostgreSQL, Redis)
  - Настроить переменные окружения и конфигурацию
  - _Требования: 11.4, 13.5_

- [x] 2. Настройка базы данных и ORM





  - Установить и настроить Prisma ORM
  - Создать схему базы данных для users, venues, masters, services, bookings, notifications
  - Добавить PostGIS расширение для геопространственных данных
  - Создать индексы для оптимизации запросов
  - Настроить миграции базы данных
  - Создать seed скрипт с тестовыми данными
  - _Требования: 1.1, 5.2, 6.1, 7.1, 13.2_

- [x] 3. Реализация Authentication Service



- [x] 3.1 Создать модели и типы для пользователей


  - Определить TypeScript интерфейсы для User, AuthTokens
  - Создать Zod схемы для валидации регистрации и входа
  - _Требования: 2.4, 13.3_

- [x] 3.2 Реализовать регистрацию и вход


  - Создать endpoint POST /api/auth/register для регистрации
  - Создать endpoint POST /api/auth/login для входа по телефону
  - Реализовать хеширование паролей с bcrypt
  - Генерировать JWT access и refresh токены
  - _Требования: 2.1, 2.4, 13.1, 13.3_

- [x] 3.3 Реализовать аутентификацию через Telegram


  - Создать endpoint POST /api/auth/telegram
  - Валидировать Telegram auth data
  - Создавать или находить пользователя по telegramId
  - _Требования: 2.4_

- [x] 3.4 Создать middleware для защиты endpoints


  - Реализовать requireAuth middleware для проверки JWT токена
  - Реализовать requireRole middleware для проверки роли пользователя
  - Добавить обработку ошибок аутентификации
  - _Требования: 13.3_

- [ ] 4. Реализация Venue Service
- [ ] 4.1 Создать CRUD операции для заведений
  - Создать endpoint POST /api/venues для создания заведения
  - Создать endpoint GET /api/venues/:id для получения заведения
  - Создать endpoint PATCH /api/venues/:id для обновления заведения
  - Создать endpoint DELETE /api/venues/:id для удаления заведения
  - Добавить валидацию данных заведения
  - _Требования: 5.1, 5.2, 5.3_

- [ ] 4.2 Реализовать геопоиск заведений
  - Создать endpoint GET /api/venues/nearby для поиска по координатам
  - Использовать PostGIS для расчета расстояний
  - Добавить фильтры по категории, рейтингу, расстоянию
  - Реализовать пагинацию результатов
  - Кэшировать результаты поиска в Redis на 10 минут
  - _Требования: 1.1, 1.3, 11.4_

- [ ] 4.3 Интегрировать с 2GIS и Yandex Maps API
  - Создать сервис для геокодирования адресов через Yandex Maps API
  - Создать функцию для валидации координат заведения
  - Добавить обработку ошибок API
  - _Требования: 1.5_

- [ ] 4.4 Реализовать управление мастерами
  - Создать endpoint POST /api/venues/:id/masters для добавления мастера
  - Создать endpoint GET /api/venues/:id/masters для списка мастеров
  - Создать endpoint PATCH /api/masters/:id для обновления мастера
  - Создать endpoint DELETE /api/masters/:id для удаления мастера
  - Добавить валидацию данных мастера
  - _Требования: 6.1_

- [ ] 4.5 Реализовать управление услугами
  - Создать endpoint POST /api/venues/:id/services для добавления услуги
  - Создать endpoint GET /api/venues/:id/services для списка услуг
  - Создать endpoint PATCH /api/services/:id для обновления услуги
  - Создать endpoint DELETE /api/services/:id для удаления услуги
  - Реализовать связь many-to-many между мастерами и услугами
  - _Требования: 7.1, 7.2, 7.3, 7.5_

- [ ] 4.6 Реализовать управление расписанием мастеров
  - Создать endpoint POST /api/masters/:id/schedule для настройки расписания
  - Создать endpoint GET /api/masters/:id/schedule для получения расписания
  - Сохранять расписание в JSONB формате
  - Поддерживать рабочие дни, время работы, перерывы, исключения
  - _Требования: 6.2, 6.5_

- [ ] 5. Реализация алгоритма расчета доступных слотов
- [ ] 5.1 Создать функцию генерации временных слотов
  - Получать расписание мастера из базы данных
  - Генерировать слоты на основе рабочего времени и длительности услуги
  - Учитывать перерывы и исключения в расписании
  - Исключать уже забронированные слоты
  - _Требования: 6.3, 6.4_

- [ ] 5.2 Создать endpoint для получения доступных слотов
  - Создать endpoint GET /api/masters/:id/slots с параметрами date и serviceId
  - Кэшировать результаты в Redis на 5 минут
  - Инвалидировать кэш при создании/отмене записи
  - Оптимизировать запросы к базе данных
  - _Требования: 2.2, 11.4_

- [ ] 6. Реализация Booking Service
- [ ] 6.1 Создать функцию создания записи с проверкой доступности
  - Создать endpoint POST /api/bookings
  - Валидировать входные данные (venueId, masterId, serviceId, startTime, clientPhone)
  - Проверять доступность слота с блокировкой (SELECT FOR UPDATE)
  - Создавать запись в транзакции
  - Устанавливать статус PENDING
  - _Требования: 2.1, 2.2, 2.3, 2.5_

- [ ] 6.2 Реализовать управление записями
  - Создать endpoint GET /api/bookings/:id для получения записи
  - Создать endpoint PATCH /api/bookings/:id для обновления записи
  - Создать endpoint DELETE /api/bookings/:id для отмены записи
  - Создать endpoint POST /api/bookings/:id/confirm для подтверждения
  - Создать endpoint POST /api/bookings/:id/complete для завершения
  - Создать endpoint POST /api/bookings/:id/no-show для отметки неявки
  - Добавить проверки прав доступа (клиент может отменить свою запись, владелец - любую)
  - _Требования: 8.3, 8.4_

- [ ] 6.3 Создать endpoints для списков записей
  - Создать endpoint GET /api/bookings/my для записей клиента
  - Создать endpoint GET /api/venues/:id/bookings для записей заведения
  - Добавить фильтры по статусу, дате, мастеру
  - Реализовать пагинацию
  - _Требования: 4.1, 4.2, 8.1, 8.2_

- [ ] 7. Реализация Notification Service
- [ ] 7.1 Создать базовую систему уведомлений
  - Создать модели для notifications и notification_preferences
  - Создать функцию для создания уведомления в базе данных
  - Создать очередь уведомлений в Redis Bull
  - Создать worker для обработки очереди
  - _Требования: 3.1, 9.1_

- [ ] 7.2 Интегрировать Telegram Bot API
  - Настроить Telegram Bot через BotFather
  - Создать функцию отправки сообщений через Telegram API
  - Обрабатывать ошибки отправки
  - Логировать статус отправки
  - _Требования: 3.1, 9.2_

- [ ] 7.3 Интегрировать SMS Gateway
  - Настроить подключение к SMSC.ru или Twilio
  - Создать функцию отправки SMS
  - Добавить форматирование номеров телефонов
  - Обрабатывать ошибки отправки
  - _Требования: 3.1, 9.2_

- [ ] 7.4 Интегрировать Firebase Cloud Messaging
  - Настроить Firebase проект
  - Создать функцию отправки push-уведомлений
  - Сохранять FCM токены пользователей
  - Обрабатывать ошибки отправки
  - _Требования: 3.1, 9.2_

- [ ] 7.5 Реализовать отправку уведомлений о записях
  - Создать функцию sendBookingCreated для уведомления при создании записи
  - Создать функцию sendBookingConfirmed для уведомления при подтверждении
  - Создать функцию sendBookingCancelled для уведомления при отмене
  - Включать в уведомление детали записи (дата, время, адрес, мастер, услуга)
  - Добавлять ссылку для отмены/переноса записи
  - Интегрировать с Booking Service для автоматической отправки
  - _Требования: 3.1, 3.4, 3.5, 8.5, 9.3, 9.4_

- [ ] 7.6 Реализовать систему напоминаний
  - Создать cron job для проверки предстоящих записей
  - Планировать напоминание за 24 часа до записи
  - Планировать напоминание за 2 часа до записи
  - Отправлять напоминания через выбранный канал пользователя
  - _Требования: 3.2, 3.3_

- [ ] 7.7 Создать управление настройками уведомлений
  - Создать endpoint GET /api/notifications/preferences
  - Создать endpoint PATCH /api/notifications/preferences
  - Позволять выбирать каналы уведомлений (SMS, Telegram, Push, Email)
  - Позволять включать/отключать напоминания
  - Позволять настраивать время напоминаний
  - _Требования: 9.5_

- [ ] 8. Реализация Analytics Service
- [ ] 8.1 Создать функции расчета базовой статистики
  - Создать функцию для подсчета записей за период
  - Создать функцию для расчета процента заполненности слотов
  - Создать функцию для расчета процента no-show
  - Оптимизировать запросы с использованием агрегации
  - _Требования: 10.1, 10.2, 10.5_

- [ ] 8.2 Создать функции статистики по мастерам и услугам
  - Создать функцию для статистики по мастерам (количество записей, выручка)
  - Создать функцию для статистики по услугам (популярность, выручка)
  - Группировать данные по периодам (день, неделя, месяц)
  - _Требования: 10.3, 10.4_

- [ ] 8.3 Создать endpoint для аналитики
  - Создать endpoint GET /api/analytics/venues/:id/overview
  - Создать endpoint GET /api/analytics/venues/:id/bookings
  - Создать endpoint GET /api/analytics/venues/:id/masters
  - Создать endpoint GET /api/analytics/venues/:id/services
  - Кэшировать результаты в Redis на 15 минут
  - Добавить проверку прав доступа (только владелец заведения)
  - _Требования: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 9. Создание Web приложения (Next.js)
- [ ] 9.1 Настроить Next.js проект
  - Инициализировать Next.js 14+ с App Router
  - Настроить TypeScript и Tailwind CSS
  - Настроить цветовую палитру (#2563EB, #06B6D4, #F9FAFB, #111827)
  - Создать базовую структуру папок (app, components, lib, types)
  - Настроить React Query для работы с API
  - _Требования: 11.1, 12.4_

- [ ] 9.2 Создать базовые UI компоненты
  - Создать компонент Button с вариантами (primary, secondary, outline, ghost)
  - Создать компонент Input для форм
  - Создать компонент Card для карточек
  - Создать компонент Modal для модальных окон
  - Создать компонент Loader для индикации загрузки
  - Создать компонент Badge для статусов
  - Использовать цветовую палитру Qlink
  - _Требования: 12.1, 12.2, 12.3_

- [ ] 9.3 Создать Layout компоненты
  - Создать компонент Header с логотипом и навигацией
  - Создать компонент Footer
  - Создать компонент Container для центрирования контента
  - Обеспечить адаптивность для мобильных, планшетов, десктопов
  - _Требования: 12.1, 12.2, 12.3, 12.5_

- [ ] 9.4 Реализовать страницу с картой заведений
  - Интегрировать React-Leaflet для отображения карты
  - Подключить 2GIS или Yandex Maps тайлы
  - Получать геолокацию пользователя
  - Отображать маркеры заведений на карте
  - Создать компонент VenueCard для краткой информации о заведении
  - Добавить фильтры по типу услуг, рейтингу, расстоянию
  - Оптимизировать загрузку карты (< 2 сек)
  - _Требования: 1.1, 1.2, 1.3, 1.4, 11.1, 11.4_

- [ ] 9.5 Реализовать процесс записи (3 шага)
  - Создать компонент BookingFlow для управления шагами
  - Шаг 1: Создать компонент ServiceSelector для выбора услуги
  - Шаг 2: Создать компонент TimeSlotPicker для выбора времени
  - Шаг 3: Создать компонент BookingConfirmation для подтверждения
  - Запрашивать минимальные данные (телефон, имя опционально)
  - Отправлять запрос на создание записи
  - Показывать успешное подтверждение с деталями записи
  - _Требования: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 9.6 Создать страницу личного кабинета клиента
  - Создать страницу /profile с историей записей
  - Отображать предстоящие, завершенные, отмененные записи
  - Добавить фильтры по статусу
  - Создать кнопку "Записаться снова" для завершенных записей
  - Добавить возможность отмены предстоящих записей
  - _Требования: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 9.7 Реализовать аутентификацию на frontend
  - Создать страницу /login для входа
  - Создать форму входа по телефону
  - Добавить кнопку "Войти через Telegram"
  - Сохранять JWT токены в localStorage
  - Создать AuthContext для управления состоянием аутентификации
  - Добавить защиту приватных страниц
  - _Требования: 2.1, 2.4_

- [ ] 9.8 Создать панель управления для владельца заведения
  - Создать страницу /dashboard с календарем записей
  - Отображать записи в виде календаря с цветовой индикацией
  - Добавить фильтры по мастеру, дате, статусу
  - Создать модальное окно с деталями записи
  - Добавить кнопки для подтверждения, отмены, переноса записи
  - Отображать базовую статистику (записи за день, выручка)
  - _Требования: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 9.9 Создать страницы управления заведением
  - Создать страницу /dashboard/masters для управления мастерами
  - Создать страницу /dashboard/services для управления услугами
  - Создать страницу /dashboard/schedule для настройки расписания
  - Создать страницу /dashboard/analytics для просмотра аналитики
  - Добавить формы для создания/редактирования мастеров и услуг
  - _Требования: 6.1, 6.2, 7.1, 7.2, 7.3, 10.1, 10.2, 10.3, 10.4_

- [ ] 9.10 Реализовать мастер быстрой регистрации заведения
  - Создать многошаговую форму регистрации
  - Шаг 1: Базовая информация (название, адрес, категория)
  - Шаг 2: Добавление первого мастера
  - Шаг 3: Добавление первых услуг
  - Шаг 4: Настройка базового расписания
  - Ограничить время прохождения до 5 минут
  - Активировать заведение на карте после завершения
  - _Требования: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 10. Оптимизация производительности
- [ ] 10.1 Реализовать кэширование на backend
  - Кэшировать информацию о заведениях в Redis (TTL: 1 час)
  - Кэшировать доступные слоты в Redis (TTL: 5 минут)
  - Кэшировать результаты геопоиска в Redis (TTL: 10 минут)
  - Кэшировать аналитику в Redis (TTL: 15 минут)
  - Инвалидировать кэш при изменении данных
  - _Требования: 11.4_

- [ ] 10.2 Оптимизировать database queries
  - Добавить индексы для часто используемых запросов
  - Использовать eager loading для связанных данных
  - Реализовать пагинацию для больших списков
  - Оптимизировать N+1 запросы
  - _Требования: 11.4_

- [ ] 10.3 Оптимизировать frontend
  - Настроить code splitting для страниц
  - Использовать React.memo для предотвращения ререндеров
  - Добавить lazy loading для изображений
  - Оптимизировать изображения (WebP с fallback)
  - Настроить CDN для статических ресурсов
  - _Требования: 11.1, 11.2, 11.3, 11.5_

- [ ] 10.4 Добавить мониторинг производительности
  - Настроить Prometheus для сбора метрик
  - Настроить Grafana для визуализации
  - Отслеживать response time, throughput, error rate
  - Настроить алерты для критических метрик
  - _Требования: 11.1, 11.2, 11.3_

- [ ] 11. Безопасность и соответствие требованиям
- [ ] 11.1 Реализовать защиту от атак
  - Добавить rate limiting для API endpoints
  - Настроить CORS политику
  - Добавить helmet.js для security headers
  - Настроить Content Security Policy
  - Добавить защиту от CSRF атак
  - _Требования: 13.1_

- [ ] 11.2 Реализовать шифрование данных
  - Использовать bcrypt для хеширования паролей (cost factor 12)
  - Шифровать чувствительные данные в БД (AES-256)
  - Настроить HTTPS для всех соединений (TLS 1.3)
  - Использовать HttpOnly cookies для токенов
  - _Требования: 13.1, 13.2_

- [ ] 11.3 Реализовать соответствие 152-ФЗ
  - Создать таблицу user_consents для согласий на обработку данных
  - Создать таблицу audit_log для журналирования доступа
  - Добавить форму согласия при регистрации
  - Реализовать функцию удаления данных пользователя
  - Логировать все операции с персональными данными
  - _Требования: 13.4_

- [ ] 11.4 Настроить резервное копирование
  - Настроить ежедневное резервное копирование PostgreSQL
  - Настроить резервное копирование Redis snapshots
  - Настроить хранение бэкапов в S3
  - Создать процедуру восстановления из бэкапа
  - _Требования: 13.5_

- [ ]* 12. Тестирование
- [ ]* 12.1 Написать unit тесты для backend
  - Тесты для AuthService (регистрация, вход, токены)
  - Тесты для VenueService (CRUD, геопоиск)
  - Тесты для BookingService (создание, валидация, проверка доступности)
  - Тесты для NotificationService (отправка, планирование)
  - Тесты для AnalyticsService (расчет статистики)
  - Coverage: минимум 80%
  - _Требования: все_

- [ ]* 12.2 Написать integration тесты для API
  - Тесты для auth endpoints
  - Тесты для venue endpoints
  - Тесты для booking endpoints
  - Тесты для notification endpoints
  - Тесты для analytics endpoints
  - _Требования: все_

- [ ]* 12.3 Написать E2E тесты для критических сценариев
  - Тест: регистрация и вход пользователя
  - Тест: поиск заведения и создание записи
  - Тест: управление записями владельцем
  - Тест: получение уведомлений
  - Использовать Playwright или Cypress
  - _Требования: 1.1-1.5, 2.1-2.5, 8.1-8.5_

- [ ] 13. Развертывание и документация
- [ ] 13.1 Настроить CI/CD pipeline
  - Создать GitHub Actions workflow для тестирования
  - Создать workflow для сборки Docker образов
  - Создать workflow для деплоя на production
  - Настроить автоматический rollback при ошибках
  - _Требования: 11.1, 11.2, 11.3_

- [ ] 13.2 Создать Docker конфигурацию
  - Создать Dockerfile для backend
  - Создать Dockerfile для frontend
  - Создать docker-compose.yml для локальной разработки
  - Оптимизировать размер образов (multi-stage build)
  - _Требования: 11.1, 11.2, 11.3_

- [ ] 13.3 Настроить production окружение
  - Настроить Kubernetes deployment
  - Настроить load balancer
  - Настроить auto-scaling
  - Настроить мониторинг и логирование
  - Настроить SSL сертификаты
  - _Требования: 11.1, 11.2, 11.3, 13.1_

- [ ]* 13.4 Создать API документацию
  - Документировать все API endpoints с примерами
  - Использовать OpenAPI/Swagger спецификацию
  - Создать интерактивную документацию (Swagger UI)
  - Добавить примеры запросов и ответов
  - _Требования: все_

- [ ]* 13.5 Создать документацию для разработчиков
  - Написать README с инструкциями по запуску проекта
  - Документировать архитектуру системы
  - Создать руководство по развертыванию
  - Документировать процесс разработки и code review
  - _Требования: все_
