// Prisma Schema для Qlink

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Пользователи (клиенты)
model User {
  id            String    @id @default(cuid())
  telegramId    String?   @unique
  phone         String    @unique
  firstName     String
  lastName      String?
  email         String?   @unique
  avatar        String?
  
  // Программа лояльности
  bonusPoints   Int       @default(0)
  totalSpent    Float     @default(0)
  
  // Настройки уведомлений
  notifyEmail   Boolean   @default(true)
  notifySms     Boolean   @default(true)
  notifyTelegram Boolean  @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  bookings      Booking[]
  reviews       Review[]
  favorites     Favorite[]
  notifications Notification[]
  loyaltyHistory LoyaltyHistory[]
  
  @@index([telegramId])
  @@index([phone])
  @@index([email])
}

// Владельцы бизнеса
model BusinessOwner {
  id            String    @id @default(cuid())
  userId        String?   @unique
  email         String    @unique
  phone         String    @unique
  password      String    // Хешированный пароль
  firstName     String
  lastName      String
  company       String?
  avatar        String?
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  businesses    Business[]
  
  @@index([email])
}

// Бизнесы (салоны, барбершопы и т.д.)
model Business {
  id              String    @id @default(cuid())
  ownerId         String
  name            String
  slug            String    @unique
  description     String?
  category        BusinessCategory
  
  // Контакты
  phone           String
  email           String?
  website         String?
  
  // Адрес
  address         String
  city            String
  country         String    @default("Russia")
  latitude        Float?
  longitude       Float?
  
  // Рабочее время
  workingHours    Json      // {monday: {open: "09:00", close: "21:00"}, ...}
  
  // Медиа
  logo            String?
  coverImage      String?
  images          String[]  @default([])
  
  // Статистика
  rating          Float     @default(0)
  reviewCount     Int       @default(0)
  bookingCount    Int       @default(0)
  
  // Настройки
  isActive        Boolean   @default(true)
  isVerified      Boolean   @default(false)
  autoConfirm     Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  owner           BusinessOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  staff           Staff[]
  services        Service[]
  bookings        Booking[]
  reviews         Review[]
  favorites       Favorite[]
  
  @@index([ownerId])
  @@index([category])
  @@index([city])
  @@index([slug])
}

enum BusinessCategory {
  BEAUTY
  MEDICAL
  SPORT
  AUTO
  HOME_SERVICES
  ENTERTAINMENT
  OTHER
}

// Сотрудники
model Staff {
  id            String    @id @default(cuid())
  businessId    String
  firstName     String
  lastName      String
  position      String
  avatar        String?
  bio           String?
  
  // Рабочее время
  workingHours  Json      // {monday: {open: "09:00", close: "21:00"}, ...}
  
  // Статистика
  rating        Float     @default(0)
  reviewCount   Int       @default(0)
  
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  services      ServiceStaff[]
  bookings      Booking[]
  
  @@index([businessId])
}

// Услуги
model Service {
  id            String    @id @default(cuid())
  businessId    String
  name          String
  description   String?
  category      String
  
  // Цена и время
  price         Float
  duration      Int       // в минутах
  
  // Медиа
  image         String?
  
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  staff         ServiceStaff[]
  bookings      Booking[]
  
  @@index([businessId])
  @@index([category])
}

// Связь услуг и сотрудников
model ServiceStaff {
  id          String   @id @default(cuid())
  serviceId   String
  staffId     String
  
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  staff       Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  @@unique([serviceId, staffId])
  @@index([serviceId])
  @@index([staffId])
}

// Записи
model Booking {
  id            String    @id @default(cuid())
  userId        String
  businessId    String
  serviceId     String
  staffId       String?
  
  // Дата и время
  date          DateTime
  startTime     String    // "14:00"
  endTime       String    // "15:30"
  
  // Статус
  status        BookingStatus @default(PENDING)
  
  // Цена
  price         Float
  
  // Комментарий
  comment       String?
  
  // Напоминания
  reminderSent  Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service       Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  staff         Staff?    @relation(fields: [staffId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([businessId])
  @@index([date])
  @@index([status])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Отзывы
model Review {
  id            String    @id @default(cuid())
  userId        String
  businessId    String
  
  rating        Int       // 1-5
  comment       String?
  images        String[]  @default([])
  
  // Ответ владельца
  response      String?
  responseDate  DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([businessId])
  @@index([rating])
}

// Избранное
model Favorite {
  id            String    @id @default(cuid())
  userId        String
  businessId    String
  
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
}

// Уведомления
model Notification {
  id            String    @id @default(cuid())
  userId        String
  
  type          NotificationType
  title         String
  message       String
  data          Json?
  
  isRead        Boolean   @default(false)
  isSent        Boolean   @default(false)
  
  // Каналы доставки
  channels      NotificationChannel[]
  
  createdAt     DateTime  @default(now())
  sentAt        DateTime?
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([isSent])
}

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_REMINDER
  BOOKING_CANCELLED
  REVIEW_RECEIVED
  PROMOTION
  PAYMENT_SUCCESS
  PAYMENT_FAILED
}

enum NotificationChannel {
  TELEGRAM
  EMAIL
  SMS
  PUSH
}

// Финансы
model Transaction {
  id            String    @id @default(cuid())
  businessId    String
  bookingId     String?
  userId        String?
  
  type          TransactionType
  amount        Float
  currency      String    @default("RUB")
  description   String?
  
  // Платежная система
  paymentMethod PaymentMethod?
  paymentId     String?   // ID транзакции в платежной системе
  
  status        TransactionStatus @default(PENDING)
  
  metadata      Json?
  
  createdAt     DateTime  @default(now())
  completedAt   DateTime?
  
  @@index([businessId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

enum TransactionType {
  BOOKING_PAYMENT
  REFUND
  SUBSCRIPTION
  COMMISSION
  BONUS
  WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CARD
  CASH
  BANK_TRANSFER
  YOOKASSA
  STRIPE
  PAYPAL
}

// Подписки для бизнесов
model Subscription {
  id            String    @id @default(cuid())
  businessId    String
  
  plan          SubscriptionPlan
  status        SubscriptionStatus
  
  startDate     DateTime
  endDate       DateTime
  
  price         Float
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([businessId])
  @@index([status])
}

enum SubscriptionPlan {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

// Промокоды
model PromoCode {
  id            String    @id @default(cuid())
  code          String    @unique
  
  discount      Float     // процент или сумма
  discountType  DiscountType
  
  maxUses       Int?
  usedCount     Int       @default(0)
  
  validFrom     DateTime
  validUntil    DateTime
  
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  
  @@index([code])
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// Аналитика
model Analytics {
  id            String    @id @default(cuid())
  businessId    String
  
  date          DateTime
  
  // Метрики
  views         Int       @default(0)
  bookings      Int       @default(0)
  revenue       Float     @default(0)
  newClients    Int       @default(0)
  
  createdAt     DateTime  @default(now())
  
  @@unique([businessId, date])
  @@index([businessId])
  @@index([date])
}

// История программы лояльности
model LoyaltyHistory {
  id            String    @id @default(cuid())
  userId        String
  
  type          LoyaltyType
  points        Int
  description   String?
  
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
}

enum LoyaltyType {
  EARNED
  SPENT
  BONUS
  EXPIRED
}

// Email шаблоны
model EmailTemplate {
  id            String    @id @default(cuid())
  name          String    @unique
  subject       String
  body          String
  variables     Json?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([name])
}

// SMS шаблоны
model SmsTemplate {
  id            String    @id @default(cuid())
  name          String    @unique
  body          String
  variables     Json?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([name])
}

// Экспорт данных
model DataExport {
  id            String    @id @default(cuid())
  businessId    String
  
  type          ExportType
  format        ExportFormat
  
  status        ExportStatus @default(PENDING)
  fileUrl       String?
  
  filters       Json?
  
  createdAt     DateTime  @default(now())
  completedAt   DateTime?
  
  @@index([businessId])
  @@index([status])
}

enum ExportType {
  BOOKINGS
  CLIENTS
  REVENUE
  ANALYTICS
  FULL
}

enum ExportFormat {
  CSV
  EXCEL
  PDF
  JSON
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
